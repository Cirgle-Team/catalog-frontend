<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="/lib/bootstrap.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
        <script src="https://kit.fontawesome.com/04ed03d0b6.js" crossorigin="anonymous"></script>
        
        <link rel="stylesheet" href="/css/common.css">
        <link rel="stylesheet" href="/css/font.css">
        <link rel="stylesheet" href="/css/index.css">

        <!--<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">-->
        <meta name="viewport" content="width=device-width">
        
        <title>Catalog</title>
        
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-title" content="catalog">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        
        <link rel="shortcut icon" sizes="256x256" href="/favicon.ico">
        <link rel="apple-touch-icon" sizes="256x256" href="/favicon.ico">
        <link rel="apple-touch-icon-precomposed" sizes="256x256" href="/favicon.ico">
    </head>

    <body>
        <nav class="navbar navbar-expand-lg bg-body-tertiary">
            <a class="navbar-brand" href="/"><img src="/src/logo.png" alt="" width="20" height="20"> Catalog</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-link" href="/streak">최근 기록</a>
                    <a class="nav-link" href="/setting">설정</a>
                </div>
            </div>
        </nav>
        <div class="main-container shadow">
              
            <div class="top-banner">
                <div class="banner-content">
                    <h5>· 오늘의 카페인 상식 ·</h5>
                    <p style="font-size:1.1em;">초콜릿에도 카페인이 있어요!</p>
                </div>
            </div>

            <div class="content-container">
                <div class="overlay-banner shadow">
                    <h5 style="letter-spacing:-1px;">남은 권장 섭취량</h5>
                    <h1 style="font-size:2.8em; letter-spacing:-1px;"><text id="remainCapacity"></text><small style="font-size:0.6em;">mg</small></h1>
                    <div class="progress-container">
                        <div class="progress" id="remainBarBox" role="progressbar" style="height:30px;">
                            <div class="progress-bar" id="remainBar" style="width: 0%">
                                <h6><small id="remainKawaii"></small></h6>
                            </div>
                        </div>
                        <div style="width:100%; padding-top:10px; display:flex; flex-direction: row; justify-content: space-between;">
                            <h6>0mg</h6>
                            <h6 id="maxCaffeine"></h6>
                        </div>
                    </div>
                    <div class="overlay-banner-btn-group">
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#recordModal" style="padding-top:8px; padding-bottom:8px;">기록하기</button>
                    </div>
                </div>

                <!--Main Content Start-->
                <h4 class="card-title">Recent Logs</h4>
                <div class="content-card" onclick="location.href='/streak'">
                    <h6 style="margin-bottom:5px;">최장 기록 : <text id="maxi">0</text>일</h6>
                    <div class="streak"></div>
                    <p style="margin:20px 0px 0px 0px; font-family: 'Pretendard-Regular'; color:#999;">
                        <i class="fa-solid fa-circle-info"></i>
                        <text  id="streakAdvisor">
                        </text>
                    </p>
                    <i class="fa-solid fa-arrow-right fa-lg" style="color:#777; margin:30px 0px 10px 0px;"></i>
                </div>

                <h4 class="card-title">Categories</h4>
                <div class="content-card" onclick="location.href='/streak'">
                    <div class="progress-container" style="margin-top:3px;">
                        <div class="progress" role="progressbar" style="height:20px; margin-bottom:2px;">
                            <div class="progress-bar cat-progress-bar" style="width: 0%; background-color: #7f4f24;"></div>
                            <div class="progress-bar cat-progress-bar" style="width: 0%; background-color: #a68a64;"></div>
                            <div class="progress-bar cat-progress-bar" style="width: 0%; background-color: #936639;"></div>
                            <div class="progress-bar cat-progress-bar" style="width: 0%; background-color: #582f0e;"></div>
                        </div>
                        <div class="index-container">
                            <div class="index-box">
                                <div class="index-indicator" style="background-color:#7f4f24;"></div>
                                <small>커피<small id="C"> 0%</small></small>
                            </div>
                            <div class="index-box">
                                <div class="index-indicator" style="background-color:#a68a64;"></div>
                                <small>에너지음료<small id="E"> 0%</small></small>
                            </div>
                            <div class="index-box">
                                <div class="index-indicator" style="background-color:#936639;"></div>
                                <small>디저트<small id="D"> 0%</small></small>
                            </div>
                            <div class="index-box">
                                <div class="index-indicator" style="background-color:#582f0e;"></div>
                                <small>기타<small id="G"> 0%</small></small>
                            </div>
                        </div>
                    </div>
                    <i class="fa-solid fa-arrow-right fa-lg" style="color:#777; margin:30px 0px 10px 0px;"></i>
                </div>
            </div>
        </div>

        <div class="modal fade" id="recordModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header" style="border:none;">
                        <h1 class="modal-title fs-5">기록하기</h1>
                    </div>
                    <div class="modal-body">
                        <select id="cat" class="form-select mb-2" onchange="catChange()">
                            <option value="no" selected>카테고리</option>
                            <option value="COFFEE">커피</option>
                            <option value="ENERGY_DRINK">에너지음료</option>
                            <option value="DESSERT">디저트</option>
                            <option value="ETC">기타</option>
                        </select>
                        <select id="menu" class="form-select mb-2" onchange="menuChange()">
                            <option value="no" selected>메뉴</option>
                        </select>
                        <div id="newMenu" style="display:none;">
                            <input id="newMenuName" class="form-control mb-2" placeholder="메뉴명">
                        </div>
                        <input id="newDensity" disabled type=number inputmode="numeric" max="999" pattern="[0-9]*" class="form-control" placeholder="카페인 함량" onchange="if(this.value > 999) this.value=999;">
                    </div>
                    <div class="modal-footer" style="border:none;">
                        <button type="button" class="btn btn-sm btn-outline-primary"
                                data-bs-dismiss="modal">취소</button>
                        <button type="button" id="recordCommit" disabled class="btn btn-sm btn-primary">기록하기</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>

<script>
    if (!localStorage.getItem('refreshToken')) {
        location.href="./login";
    }
    
    typer = [0, 0, 0, 0];
    keys = ["COFFEE", "ENERGY_DRINK", "DESSERT", "ETC"];
    shortKeys = ["C", "E", "D", "G"];

    async function getType(type, date) {
        //holy cow
        {
            query = new FormData();
            query.append("path", "api/v1/caffeine-menu/type?type="+type+"&start="+date+"&end="+date);
            query.append("req", JSON.stringify({
                                    "refreshToken" : localStorage.getItem('refreshToken'),
                                }));
            query.append("header", "Authorization:"+aToken);
            query.append("method", "GET");

            return fetch('https://catalog.cirgle.me/relay.php', {
                method: 'POST',
                body: query
            })
            .then(res => res.json());
        };
    }

    async function GyuSo(date) {
        hap = 0;
        for (kkk = 0; kkk < 4; kkk++) {
            data = await getType(keys[kkk], date);        
            if (data["code"] != "success") {
                alert("서버에 문제가 발생했습니다!\n");
                return;
            }
        
            for (i = 0;  i < data["consumedMenuList"].length; i++) {
                typer[kkk] += data["consumedMenuList"][i]["caffeine"];
            }
            hap += typer[kkk];
        }
        for (i = 0; i < 4; i++) {
            document.querySelectorAll(".cat-progress-bar")[i].style.width = (typer[i] / hap * 100) + "%";
            document.querySelector("#"+shortKeys[i]).innerText = " "+~~((typer[i] / hap * 100)*100)/100 + "%";
        }
    }
    
    // Signed in Status

    aToken = ""
    maxCaffeineNum = 0;
    remainCapacityNum = 0;
    remainRatio = 0;

    menuList = {"COFFEE":[], "ENERGY_DRINK":[], "DESSERT":[], "ETC":[]};
    
    query = new FormData();
    query.append("path", "refresh");
    query.append("req", JSON.stringify({
                            "refreshToken" : localStorage.getItem('refreshToken'),
                        }));

    //init
    {
        fetch('https://catalog.cirgle.me/relay.php', {
            method: 'POST',
            body: query
        })
        .then(res => res.json())
        .then(data => {
            if (data["code"] != "success") {
                if (data["code"] == "invalid-005" || data["code"] == "invalid-001") {
                    alert("토큰이 유효하지 않습니다!");
                    localStorage.setItem('refreshToken', "");
                    location.href="/";
                    return;
                }
                alert("서버에 문제가 발생했습니다!\n");
                return;
            }
            aToken = data["token"]["accessToken"];

            //streak Dog yo start
            {
                query = new FormData();
                query.append("path", "api/v1/caffeine-log");
                query.append("req", JSON.stringify({
                                        "refreshToken" : localStorage.getItem('refreshToken'),
                                    }));
                query.append("header", "Authorization:"+aToken);
                query.append("method", "GET");

                fetch('https://catalog.cirgle.me/relay.php', {
                    method: 'POST',
                    body: query
                })
                .then(res => res.json())
                .then(data => {
                if (data["code"] != "success") {
                    if (data["code"] == "invalid-005" || data["code"] == "invalid-001") {
                        alert("토큰이 유효하지 않습니다!");
                        localStorage.setItem('refreshToken', "");
                        location.href="/";
                    }
                    alert("서버에 문제가 발생했습니다!\n");
                    return;
                }
                //Core Part
                maxCaffeine.innerText = data["caffeineLogDetail"]["maxCaffeine"]+"mg";
                maxCaffeineNum = data["caffeineLogDetail"]["maxCaffeine"];
                maxi.innerText = data["caffeineLogDetail"]["maxStreak"];
                if (data["caffeineLogDetail"]["streak"] > 0) {
                    streakAdvisor.innerText = data["caffeineLogDetail"]["streak"] + "일 연속 카페인을 건강하게 섭취했어요!";
                } else {
                    streakAdvisor.innerText = "건강을 생각해보는건 어떨까요?";
                }
                //Core Part END
            });
            }
            //streak Dog yo end

            //streak Today start
            {
                query = new FormData();
                query.append("path", "api/v1/caffeine-log/today");
                query.append("req", JSON.stringify({
                                        "refreshToken" : localStorage.getItem('refreshToken'),
                                    }));
                query.append("header", "Authorization:"+aToken);
                query.append("method", "GET");

                fetch('https://catalog.cirgle.me/relay.php', {
                    method: 'POST',
                    body: query
                })
                .then(res => res.json())
                .then(data => {
                if (data["code"] != "success") {
                    if (data["code"] == "invalid-005" || data["code"] == "invalid-001") {
                        alert("토큰이 유효하지 않습니다!");
                        localStorage.setItem('refreshToken', "");
                        location.href="/";
                    }
                    alert("서버에 문제가 발생했습니다!\n");
                    return;
                }
                //Core Part
                remainCapacityNum = maxCaffeineNum - (data["caffeineLog"]["consumedCaffeine"]-0) < 0 ? 0 : maxCaffeineNum - (data["caffeineLog"]["consumedCaffeine"]-0);
                remainCapacity.innerText = remainCapacityNum;
                remainKawaii.innerText = remainCapacityNum + "mg";
                if (maxCaffeineNum - (data["caffeineLog"]["consumedCaffeine"]-0) >= 0) {
                    remainRatio = remainCapacityNum / maxCaffeineNum * 100;
                } else {
                    abser = -(maxCaffeineNum - (data["caffeineLog"]["consumedCaffeine"]-0));
                    remainRatio = 0;
                    remainBarBox.style.backgroundColor = "#880000";
                    remainBarBox.style.display = "flex";
                    remainBarBox.style.flexDirection = "row";
                    remainBarBox.style.alignItems = "center";
                    remainBarBox.innerHTML = 
                        '<h6 style="width:100%; color:white; text-align:center;">오늘 '+abser+'mg 더 먹었어요!</h6>';
                }
                remainBar.style.width = remainRatio + "%";
                //Core Part END
            });
            };
            //streak Today end

            //streak Daily start
            {
                query = new FormData();
                query.append("path", "api/v1/caffeine-log/daily?start=2023-09-01&end=2023-12-01");
                query.append("req", JSON.stringify({
                                        "refreshToken" : localStorage.getItem('refreshToken'),
                                    }));
                query.append("header", "Authorization:"+aToken);
                query.append("method", "GET");

                fetch('https://catalog.cirgle.me/relay.php', {
                    method: 'POST',
                    body: query
                })
                .then(res => res.json())
                .then(data => {
                    if (data["code"] != "success") {
                        if (data["code"] == "invalid-005" || data["code"] == "invalid-001") {
                            alert("토큰이 유효하지 않습니다!");
                            localStorage.setItem('refreshToken', "");
                            location.href="/";
                        }
                        alert("서버에 문제가 발생했습니다!\n");
                        return;
                    }
                    //Core Part
                    for (i = 0; i < 92; i++) {
                        if (!data["caffeineLogs"][i]["isSuccess"]) {
                            document.querySelectorAll(".streak-unit")[i].style.backgroundColor="#880000";
                        } else {
                            r = data["caffeineLogs"][i]["consumedCaffeine"] / data["caffeineLogs"][i]["maxCaffeine"] * 100;
                            if (r <= 20) {
                                document.querySelectorAll(".streak-unit")[i].style.backgroundColor="#90be6d";
                            } else if (r <= 40) {
                                document.querySelectorAll(".streak-unit")[i].style.backgroundColor="#f9c74f";
                            } else if (r <= 60) {
                                document.querySelectorAll(".streak-unit")[i].style.backgroundColor="#f8961e";
                            } else if (r <= 80) {
                                document.querySelectorAll(".streak-unit")[i].style.backgroundColor="#f3722c";
                            } else {
                                document.querySelectorAll(".streak-unit")[i].style.backgroundColor="#f94144";
                            }
                        }
                    }
                    //Core Part END
                });
            }
            //streak Daily end

            //GetMenu start
            {
                query = new FormData();
                query.append("path", "api/v1/caffeine-menu");
                query.append("req", JSON.stringify({
                                        "refreshToken" : localStorage.getItem('refreshToken'),
                                    }));
                query.append("header", "Authorization:"+aToken);
                query.append("method", "GET");

                fetch('https://catalog.cirgle.me/relay.php', {
                    method: 'POST',
                    body: query
                })
                .then(res => res.json())
                .then(data => {
                    if (data["code"] != "success") {
                        if (data["code"] == "invalid-005" || data["code"] == "invalid-001") {
                            alert("토큰이 유효하지 않습니다!");
                            localStorage.setItem('refreshToken', "");
                            location.href="/";
                        }
                        alert("서버에 문제가 발생했습니다!\n");
                        return;
                    }
                    //Core Part
                    for (i = 0; i < data["menuList"].length; i++) {
                        menuList[data["menuList"][i]["type"]].push([data["menuList"][i]["name"],data["menuList"][i]["caffeine"]]);
                    }
                    //Core Part END
                });
            }
            //GetMenu end

            let today = new Date();   
            let year = today.getFullYear(); // 년도
            let month = today.getMonth() + 1;  // 월
            let date = today.getDate();  // 날짜
            let day = today.getDay();  // 요일
            GyuSo(year + '-' + month + '-' + date);
        });
    }

    recordCommit.onclick = () => {
        //Submit start
        {
            query = new FormData();
            query.append("path", "api/v1/caffeine-log");
            if (menu.value == "self") {
                tn = newMenuName.value;
            } else {
                tn = menu.value;
            }
            query.append("req", JSON.stringify({
                                    "menu" : tn,
                                    "type" : cat.value,
                                    "caffeine" : newDensity.value
                                }));
            query.append("header", "Authorization:"+aToken);

            fetch('https://catalog.cirgle.me/relay.php', {
                method: 'POST',
                body: query
            })
            .then(res => res.json())
            .then(data => {
                if (data["code"] != "success") {
                    alert("서버에 문제가 발생했습니다!\n");
                    return;
                }
                //Core Part
                alert("카페인 소비가 성공적으로 기록되었습니다!");
                location.href="/";
                //Core Part END
            });
        }
        //Submit GetMenu end
    };

    document.querySelector('#newDensity').addEventListener('keyup', function(){
        if(document.querySelector('#newDensity').value > 999) {
            document.querySelector('#newDensity').value=1000;
        }
        if (document.querySelector("#newDensity").value > 0 && document.querySelector("#newDensity").value <= 1000) {
            recordCommit.removeAttribute("disabled");
        } else {
            recordCommit.setAttribute("disabled", "1");
        }
    });

    function catChange() {
        if (cat.value == "no") {
            menu.innerHTML = '<option value="no" selected>메뉴</option>';
        } else {
            menu.innerHTML = '<option value="no" selected>메뉴</option>';
            for (i = 0; i < menuList[cat.value].length; i++) {
                menu.innerHTML += '<option value="'+menuList[cat.value][i][0]+'">'+menuList[cat.value][i][0]+'</option>';
            }
            menu.innerHTML += '<option value="self">직접 작성하기</option>';
        }
        menuChange();
    }

    function menuChange() {
        if (menu.value == "self") {
            newMenu.style.display = "block";
            newDensity.removeAttribute("disabled");
            newDensity.value = 0;
        } else {
            if (menu.value == "no") {
                newDensity.setAttribute("disabled", 1);
                recordCommit.setAttribute("disabled", 1);
            } else {
                for (i = 0; i < menuList[cat.value].length; i++) {
                    if (menuList[cat.value][i][0] == menu.value) {
                        newDensity.value=menuList[cat.value][i][1];
                        break;
                    }
                }
                newDensity.removeAttribute("disabled");
                recordCommit.removeAttribute("disabled");
            }
            newMenu.style.display = "none";
        }
    }

    for (i = 0; i < 93; i++) {
        document.querySelector(".streak").innerHTML += '<div class="streak-unit"></div>';
    }

    /*

    document.querySelectorAll(".streak-unit")[0].style.backgroundColor="#90be6d";
    document.querySelectorAll(".streak-unit")[1].style.backgroundColor="#f9c74f";
    document.querySelectorAll(".streak-unit")[2].style.backgroundColor="#f8961e";
    document.querySelectorAll(".streak-unit")[3].style.backgroundColor="#f3722c";
    document.querySelectorAll(".streak-unit")[4].style.backgroundColor="#f94144";
    document.querySelectorAll(".streak-unit")[5].style.backgroundColor="#880000";

    */
    /*
        Below 20% : #90be6d 
        Between 21% ~ 40% : #f9c74f
        Between 41% ~ 60% : #f8961e
        Between 61% ~ 80% : #f3722c
        Between 81% ~ 100% : #f94144
        Between 81% ~ 100% : #000000
    */

    /*
        #ddb892
        #b08968
        #7f5539
        #9c6644

        #a68a64
        #936639
        #7f4f24
        #582f0e
    */
</script>