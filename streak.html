<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="/lib/bootstrap.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
        <script src="https://kit.fontawesome.com/04ed03d0b6.js" crossorigin="anonymous"></script>
        
        <link rel="stylesheet" href="/css/common.css">
        <link rel="stylesheet" href="/css/font.css">
        <link rel="stylesheet" href="/css/streak.css">

        <!--<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">-->
        <meta name="viewport" content="width=device-width">
        
        <title>Catalog</title>
        
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-title" content="catalog">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        
        <link rel="shortcut icon" sizes="256x256" href="/favicon.ico">
        <link rel="apple-touch-icon" sizes="256x256" href="/favicon.ico">
        <link rel="apple-touch-icon-precomposed" sizes="256x256" href="/favicon.ico">
    </head>

    <body>
        <nav class="navbar navbar-expand-lg bg-body-tertiary">
            <a class="navbar-brand" href="/"><img src="/src/logo.png" alt="" width="20" height="20"> Catalog</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-link" href="/index">홈화면</a>
                    <a class="nav-link" href="/setting">설정</a>
                    <a class="nav-link" onclick="logout();">로그아웃</a>
                </div>
            </div>
        </nav>
        <div class="main-container shadow">
            <div id="toptoptop"></div>
            <div class="content-container">
                <h4 class="card-title">Cumulative Statistics <small><small><small>(6 months)</small></small></small></h4>
                <div class="content-card">
                    <!--<h6>여기에 통계 범위를 입력</h6>-->
                    <table class="statistic-table table">
                        <tr>
                            <td>최근 섭취한 총 카페인</td>
                            <td id="sTATtOTAL">0mg</td>
                        </tr>
                        <tr>
                            <td><b>커피</b>로 섭취한 카페인</td>
                            <td class="cUTEsTATS">0mg</td>
                        </tr>
                        <tr>
                            <td><b>에너지음료</b>로 섭취한 카페인</td>
                            <td class="cUTEsTATS">0mg</td>
                        </tr>
                        <tr>
                            <td><b>디저트</b>로 섭취한 카페인</td>
                            <td class="cUTEsTATS">0mg</td>
                        </tr>
                        <tr>
                            <td><b>기타</b>로 섭취한 카페인</td>
                            <td class="cUTEsTATS">0mg</td>
                        </tr>
                        <tr>
                            <td>권장량을 <b>지킨</b> 일수</td>
                            <td id="mYpROMISEnINE">0일</td>
                        </tr>
                        <tr>
                            <td>권장량의 <b>50% 미만</b>을 섭취한 일수</td>
                            <td id="mYmATHgRADE">0일</td>
                        </tr>
                        <tr>
                            <td>권장량을 <b>초과</b>한 일수</td>
                            <td id="nEVERuNDERESTIMATEtHEpOWERoFtHEscOUTEcODE">0일</td>
                        </tr>
                    </table>
                </div>

                <h4 class="card-title">Visualization <small><small><small>(6 months)</small></small></small></h4>
                <div class="content-card">
                    <div class="union">
                        <div style="display:flex; flex-direction: column; justify-content: space-between; margin:0px 5px 10px -10px;">
                            <div class="kawaii-unit"></div>
                            <div class="kawaii-unit"><h6><small>Mon</h6></small></div>
                            <div class="kawaii-unit"></div>
                            <div class="kawaii-unit"><h6><small>Wed</h6></small></div>
                            <div class="kawaii-unit"></div>
                            <div class="kawaii-unit"><h6><small>Fri</h6></small></div>
                            <div class="kawaii-unit"></div>
                        </div>
                        <div class="large-streak"></div>
                    </div>
                    <div>
                        <p style="margin:20px 0px 0px 0px; font-family: 'Pretendard-Regular'; color:#999;">
                            카테고리 간 섭취 비율 (<text id="Inodatelonglongtimeisad">6개월</text>)
                        </p>
                        <hr>
                        <div class="progress-container" style="margin-top:3px;">
                            <div class="progress" role="progressbar" style="height:20px; margin-bottom:2px;">
                                <div class="progress-bar" style="width: 0%; background-color: #7f4f24;"></div>
                                <div class="progress-bar" style="width: 0%; background-color: #a68a64;"></div>
                                <div class="progress-bar" style="width: 0%; background-color: #936639;"></div>
                                <div class="progress-bar" style="width: 0%; background-color: #582f0e;"></div>
                            </div>
                            <div class="index-container">
                                <div class="index-box">
                                    <div class="index-indicator" style="background-color:#7f4f24;"></div>
                                    <small>커피<small id="C"> 0%</small></small>
                                </div>
                                <div class="index-box">
                                    <div class="index-indicator" style="background-color:#a68a64;"></div>
                                    <small>에너지음료<small id="E"> 0%</small></small>
                                </div>
                                <div class="index-box">
                                    <div class="index-indicator" style="background-color:#936639;"></div>
                                    <small>디저트<small id="D"> 0%</small></small>
                                </div>
                                <div class="index-box">
                                    <div class="index-indicator" style="background-color:#582f0e;"></div>
                                    <small>기타<small id="G"> 0%</small></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>

<script>
    function logout() {
        localStorage.setItem('refreshToken', "");
        location.href="/";
    }
    if (!localStorage.getItem('refreshToken')) {
        location.href="./login";
    }

    function getDayOfWeek(yyyyMMdd){
        const dayOfWeek = new Date(yyyyMMdd).getDay(); 
        return dayOfWeek;
    }
    

    async function getType2(type, from, to) {
        //holy cow
        {
            query = new FormData();
            query.append("path", "api/v1/caffeine-menu/type?type="+type+"&start="+from+"&end="+to);
            query.append("req", JSON.stringify({
                                    "refreshToken" : localStorage.getItem('refreshToken'),
                                }));
            query.append("header", "Authorization:"+aToken);
            query.append("method", "GET");

            return fetch('https://catalog.cirgle.me/relay.php', {
                method: 'POST',
                body: query
            })
            .then(res => res.json());
        };
    }
    
    async function BoongSo(from, to) {
        typer = [0, 0, 0, 0];
        keys = ["COFFEE", "ENERGY_DRINK", "DESSERT", "ETC"];
        shortKeys = ["C", "E", "D", "G"];
        hap = 0;
        for (kkk = 0; kkk < 4; kkk++) {
            data = await getType2(keys[kkk], from, to);        
            if (data["code"] != "success") {
                alert("서버에 문제가 발생했습니다!\n");
                return;
            }
        
            for (i = 0;  i < data["consumedMenuList"].length; i++) {
                typer[kkk] += data["consumedMenuList"][i]["caffeine"];
            }
            hap += typer[kkk];
        }
        sTATtOTAL.innerText = hap+"mg";
        for (i = 0; i < 4; i++) {
            document.querySelectorAll(".cUTEsTATS")[i].innerText = typer[i]+"mg";
            document.querySelectorAll(".progress-bar")[i].style.width = (typer[i] / hap * 100) + "%";
            document.querySelector("#"+shortKeys[i]).innerText = " "+~~((typer[i] / hap * 100)*100)/100 + "%";
        }
    }

    aToken = "";
    query = new FormData();
    query.append("path", "refresh");
    query.append("req", JSON.stringify({
                            "refreshToken" : localStorage.getItem('refreshToken'),
                        }));
    //View initialization
    {
        fetch('https://catalog.cirgle.me/relay.php', {
            method: 'POST',
            body: query
        })
        .then(res => res.json())
        .then(data => {
            if (data["code"] != "success") {
                if (data["code"] == "invalid-005" || data["code"] == "invalid-001") {
                    alert("토큰이 유효하지 않습니다!");
                    localStorage.setItem('refreshToken', "");
                    location.href="/";
                    return;
                }
                alert("서버에 문제가 발생했습니다!\n");
                return;
            }
            aToken = data["token"]["accessToken"];
            
            let today = new Date();   
            let year = today.getFullYear(); // 년도
            let month = today.getMonth() + 2;  // 월
            let date = today.getDate();  // 날짜
            let day = today.getDay();  // 요일
            nextMonthFirst = year + '-' + ((month) < 10 ? "0" + (month) : (month)) + '-01';
            twoMonthAgo = year + '-' + ((month-5) < 10 ? "0" + (month-5) : (month-5)) + '-01';

            //holy cow
            {
                query = new FormData();
                query.append("path", "api/v1/caffeine-log/daily?start="+twoMonthAgo+"&end="+nextMonthFirst);
                query.append("req", JSON.stringify({
                                        "refreshToken" : localStorage.getItem('refreshToken'),
                                    }));
                query.append("header", "Authorization:"+aToken);
                query.append("method", "GET");

                fetch('https://catalog.cirgle.me/relay.php', {
                    method: 'POST',
                    body: query
                })
                .then(res => res.json())
                .then(data => {
                    if (data["code"] != "success") {
                        alert("서버에 문제가 발생했습니다!\n");
                        return;
                    }
                    //Core Part
                    initLSB = getDayOfWeek(twoMonthAgo);
                    lk99 = 0;
                    negSucc = 0;
                    successer = 0;
                    halfLetsgo = 0;
                    for (i = 0; i < data["caffeineLogs"].length; i++) {
                        dft = new Date(data["caffeineLogs"][i]["date"]);
                        fft = new Date(twoMonthAgo);
                        df = Math.floor(Math.abs((dft - fft) / (1000 * 60 * 60 * 24)));
                        
                        //console.log(df);
                        lk99 = initLSB + df;
                        k = lk99 % 7;
                        l = (lk99 - (lk99 % 7))/7;
                        giveme(l, k).value= data["caffeineLogs"][i]["date"];
                        giveme(l, k).setAttribute("onclick", 'GyuSo(this.value)');
                        if (!data["caffeineLogs"][i]["isSuccess"]) {
                            negSucc++;
                            giveme(l, k).style.backgroundColor="#880000";
                        } else {
                            successer++;
                            r = data["caffeineLogs"][i]["consumedCaffeine"] / data["caffeineLogs"][i]["maxCaffeine"] * 100;
                            if (r <= 20) {
                                giveme(l, k).style.backgroundColor="#90be6d";
                            } else if (r <= 40) {
                                giveme(l, k).style.backgroundColor="#f9c74f";
                            } else if (r <= 60) {
                                giveme(l, k).style.backgroundColor="#f8961e";
                            } else if (r <= 80) {
                                giveme(l, k).style.backgroundColor="#f3722c";
                            } else {
                                giveme(l, k).style.backgroundColor="#f94144";
                            }

                            if (r < 50) {
                                halfLetsgo++;
                            }
                        }
                        if (i == data["caffeineLogs"].length-1) {
                            giveme(l, k).scrollIntoView();
                        } document.querySelector("#toptoptop").scrollIntoView();
                    }
                        mYpROMISEnINE.innerText = successer+"일";
                        mYmATHgRADE.innerText = halfLetsgo+"일";
                        nEVERuNDERESTIMATEtHEpOWERoFtHEscOUTEcODE.innerText = negSucc+"일";
                    //Core Part END
                });
            }
            
            BoongSo(twoMonthAgo, nextMonthFirst);
        });
    }

    
    async function GyuSo(date) {
        typer = [0, 0, 0, 0];
        keys = ["COFFEE", "ENERGY_DRINK", "DESSERT", "ETC"];
        shortKeys = ["C", "E", "D", "G"];
        hap = 0;
        for (kkk = 0; kkk < 4; kkk++) {
            data = await getType(keys[kkk], date);        
            if (data["code"] != "success") {
                alert("서버에 문제가 발생했습니다!\n");
                return;
            }
        
            for (i = 0;  i < data["consumedMenuList"].length; i++) {
                typer[kkk] += data["consumedMenuList"][i]["caffeine"];
            }
            hap += typer[kkk];
        }
        Inodatelonglongtimeisad.innerText = date;
        for (i = 0; i < 4; i++) {
            document.querySelectorAll(".progress-bar")[i].style.width = (typer[i] / hap * 100) + "%";
            document.querySelector("#"+shortKeys[i]).innerText = " "+~~((typer[i] / hap * 100)*100)/100 + "%";
        }
    }

    async function getType(type, date) {
        //holy cow
        {
            query = new FormData();
            query.append("path", "api/v1/caffeine-menu/type?type="+type+"&start="+date+"&end="+date);
            query.append("req", JSON.stringify({
                                    "refreshToken" : localStorage.getItem('refreshToken'),
                                }));
            query.append("header", "Authorization:"+aToken);
            query.append("method", "GET");

            return fetch('https://catalog.cirgle.me/relay.php', {
                method: 'POST',
                body: query
            })
            .then(res => res.json());
        };
    }

    function giveme(i, j) {
        return document.querySelectorAll(".twenty-seven")[j].querySelectorAll(".streak-unit")[i];
    }

    for (i = 0; i < 7; i++) {
        document.querySelector(".large-streak").innerHTML += '<div class="twenty-seven"></div>';
    }

    for (i = 0; i < document.querySelectorAll(".twenty-seven").length; i++) {
        for (j = 0; j < 27; j++) {
            document.querySelectorAll(".twenty-seven")[i].innerHTML += '<span class="streak-unit"></span>';
        }
    }
    document.querySelectorAll(".twenty-seven")[6].style.marginBottom="10px";

    /*
    for (i = 0; i < document.querySelectorAll(".streak").length; i++) {
        for (j = 0; j < 31; j++) {
            document.querySelectorAll(".streak")[i].innerHTML += '<div class="streak-unit"></div>';
        }
    }

    document.querySelectorAll(".streak-unit")[0].style.backgroundColor="#90be6d";
    document.querySelectorAll(".streak-unit")[1].style.backgroundColor="#f9c74f";
    document.querySelectorAll(".streak-unit")[2].style.backgroundColor="#f8961e";
    document.querySelectorAll(".streak-unit")[3].style.backgroundColor="#f3722c";
    document.querySelectorAll(".streak-unit")[4].style.backgroundColor="#f94144";
    document.querySelectorAll(".streak-unit")[5].style.backgroundColor="#880000";
    */

</script>